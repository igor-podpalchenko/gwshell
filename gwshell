#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat >&2 <<USAGE
Usage:
  sudo gwshell -i <iface> <gateway-ip>

Example:
  sudo gwshell -i ens160 192.168.1.1
  sudo gwshell -i wls192 192.168.3.1
USAGE
  exit 2
}

IFACE=""
while getopts ":i:" opt; do
  case "$opt" in
    i) IFACE="$OPTARG" ;;
    *) usage ;;
  esac
done
shift $((OPTIND-1))

GW="${1:-}"
[[ -n "${IFACE}" ]] || usage
[[ -n "${GW}" ]] || usage
[[ $# -eq 1 ]] || usage

if [[ "${EUID}" -ne 0 ]]; then
  echo "ERROR: must run as root (use sudo)" >&2
  exit 1
fi

if ! ip link show dev "${IFACE}" >/dev/null 2>&1; then
  echo "ERROR: interface not found: ${IFACE}" >&2
  exit 1
fi

IFACE_CIDR="$(ip -4 -o addr show dev "${IFACE}" scope global | awk '{print $4}' | head -n1 || true)"
if [[ -z "${IFACE_CIDR}" ]]; then
  echo "ERROR: interface ${IFACE} has no global IPv4 address" >&2
  ip -4 -o addr show dev "${IFACE}" >&2 || true
  exit 1
fi

if ! [[ "${GW}" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
  echo "ERROR: gateway must be an IPv4 address: ${GW}" >&2
  exit 1
fi
IFS=. read -r a b c d <<<"${GW}"
for oct in "$a" "$b" "$c" "$d"; do
  if ((oct < 0 || oct > 255)); then
    echo "ERROR: invalid IPv4 address: ${GW}" >&2
    exit 1
  fi
done

# On-link check (avoid "GW on wrong iface" foot-gun)
if ! ip -4 route get "${GW}" 2>/dev/null | grep -q " dev ${IFACE}"; then
  echo "ERROR: gateway ${GW} is not reachable on-link via ${IFACE} (iface addr: ${IFACE_CIDR})" >&2
  echo "Hint: choose the interface that is in the same L2/subnet as the gateway." >&2
  ip -4 route get "${GW}" >&2 || true
  exit 1
fi

TABLE_ID="$(shuf -i 2000-4999 -n 1)"
MARK_HEX="$(printf '0x%X' $((0x20000 + (RANDOM & 0x0FFF))))"
RULE_PRIO="$(shuf -i 10010-10999 -n 1)"
LOG="/run/gwshell-${TABLE_ID}.log"

echo "Starting gwctx-${TABLE_ID}.service (log: ${LOG})" >&2

exec systemd-run --quiet --pty --service-type=simple \
  --unit="gwctx-${TABLE_ID}.service" \
  --property="KillMode=mixed" \
  --property="TimeoutStopSec=5s" \
  env \
    GWCTX_IFACE="${IFACE}" \
    GWCTX_GW="${GW}" \
    MARK_HEX="${MARK_HEX}" \
    TABLE_ID="${TABLE_ID}" \
    RULE_PRIO="${RULE_PRIO}" \
    GWCTX_LOG="${LOG}" \
    /usr/local/sbin/gwctx-shell
